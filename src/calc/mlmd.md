# 分子動力学と機械学習ポテンシャル

本稿は、分子動力学が解く運動方程式と統計力学の関係を出発点に、原子間相互作用を機械学習で近似する機械学習ポテンシャルがどのように導入され、何ができて何が難しいかを初学者向けに丁寧に説明するものである。古典力場と第一原理計算の立場の違いを整理したうえで、近年の等価変換性を備えたモデルが、精度と計算量の両立をどのように実現しているかを数式と具体的な判断軸で述べるものである。

### 参考ドキュメント

1. 西原慧径, 機械学習の第一原理計算への応用, 表面技術 76(3), 2025. https://www.jstage.jst.go.jp/article/sfj/76/3/76_131/_pdf
2. 若林大佑, 機械学習ポテンシャルを用いた SiO2 メルトおよびガラスの大規模分子動力学計算, 日本結晶学会誌 67(2), 2025. https://www.jstage.jst.go.jp/article/jcrsj/67/2/67_121/_pdf
3. 渡辺宙志, 分子動力学法における温度制御の基礎, 分子シミュレーションスクール資料. https://www.crl.nitech.ac.jp/~ida/education/MaterialsDesign/04_12/mdthermo.pdf

## 1. 分子動力学が解くもの

分子動力学は、原子を質点として扱い、時間発展する原子配置 $\{\mathbf{r}_i(t)\}$ と速度 $\{\mathbf{v}_i(t)\}$ を数値的に追跡する方法である。ここで本質となるのは、運動方程式が決まれば時間発展は一意に定まるという点であり、その運動方程式の右辺に現れる力 $\mathbf{F}_i$ をどう与えるかが計算の根幹である。

最も基本の形はニュートン方程式であり、
$$
m_i\frac{d^2\mathbf{r}_i}{dt^2}=\mathbf{F}_i
$$
である。力はポテンシャルエネルギー $U(\mathbf{R})$（$\mathbf{R}$ は全原子座標の集合）から
$$
\mathbf{F}_i=-\nabla_{\mathbf{r}_i}U(\mathbf{R})
$$
として与えるのが基本である。したがって分子動力学は、見方を変えれば、ポテンシャルエネルギー面 $U(\mathbf{R})$ を与えたときの力学系の時間発展を計算していることになる。



## 2. エネルギー、保存則、そして誤差の見方

外力や熱浴がない孤立系（後述の NVE）では、全エネルギー
$$
E_{\mathrm{tot}} = K + U,\quad
K=\sum_i \frac{1}{2}m_i|\mathbf{v}_i|^2
$$
が保存する。数値計算では離散時間刻み $\Delta t$ を用いるため、厳密な保存則は一般に崩れるが、良い積分法と適切な $\Delta t$ を選べば、エネルギーが長時間にわたり小さく揺らぐだけの状態を実現できる。

ここで重要なのは、エネルギーが単に増減するかだけでなく、増減の仕方を観察することである。例えば、単調に増加して発散するなら積分が不安定である可能性が高く、周期的に揺れながら平均が保たれるなら許容される場合が多い。さらに、拘束条件（結合長固定など）を使う場合、拘束解法の誤差がエネルギー挙動に混ざるため、拘束の強さや許容誤差の設定も同時に考える必要がある。



## 3. 数値積分と時間刻みの意味

分子動力学は連立常微分方程式の初期値問題であり、離散化が不可欠である。広く用いられるのは Verlet 系の積分法であり、位置 Verlet の一例は
$$
\mathbf{r}_i(t+\Delta t)=2\mathbf{r}_i(t)-\mathbf{r}_i(t-\Delta t)+\frac{\Delta t^2}{m_i}\mathbf{F}_i(t)
$$
である。速度 Verlet は位置と速度を同時に更新し、力評価を時間中央に整合させやすいという利点を持つ。

時間刻み $\Delta t$ は、最も速い運動（高周波振動）を十分に分解できる程度に小さくする必要がある。固体ではフォノンの高周波成分、分子系では軽元素の結合伸縮が代表例である。経験則としてではなく、力の変化の時間スケールに対して $\Delta t$ が大きすぎると、離散化誤差が蓄積し、エネルギー挙動や構造が現実と乖離しやすくなると理解するのがよい。



## 4. 統計力学とアンサンブルの扱い

分子動力学は力学的時間発展である一方、物性評価では温度や圧力などの巨視的量を扱う。そこで統計力学により、ミクロ状態の集合としてのアンサンブルを導入する。代表的なものは以下である。

- NVE（微視的には孤立系）  
  エネルギー一定のもとで運動する。保存則の見通しが良く、力場や積分の健全性を評価しやすい。

- NVT（温度一定）  
  カノニカル分布
  $$
  P(\mathbf{R},\mathbf{P})\propto \exp\left(-\beta H(\mathbf{R},\mathbf{P})\right),\quad \beta=\frac{1}{k_BT}
  $$
  に従う標本化を目指す。温度制御（熱浴）が必要である。

- NPT（温度・圧力一定）  
  体積も揺らぐ分布を目指す。熱浴に加え圧力制御（バロスタット）が必要である。

温度は力学的には速度分布から定義され、自由度 $f$ に対し
$$
K=\frac{f}{2}k_BT
$$
を満たすように対応づける。ここで $f$ は拘束条件の有無などで変わるため、温度換算での自由度の扱いを意識することが重要である。



## 5. 温度制御の考え方

温度制御は、系を熱浴と結合させ、NVT の標本化を実現するための仕掛けである。代表例として Nosé–Hoover 系と Langevin 系がある。

Nosé–Hoover は拡張変数を導入して決定論的に温度分布を実現しようとする。直感的には、系の運動量を時間的に伸縮させる摩擦項が入り、その強さが動的に調整される仕組みである。実際の運動方程式は拡張系として書かれ、時間定数（結合の強さ）を不適切に選ぶと、温度が大きく振動するなどの挙動が現れる。

Langevin は確率的な摩擦とランダム力を加えることで温度分布を実現する。確率過程を含むため直観的に不安に感じる場合もあるが、熱浴と接した微視的自由度を粗視化した結果として理解できる。摩擦係数が大きすぎると運動が過度に減衰し、拡散や振動スペクトルが歪みやすいという性質も併せて理解する必要がある。



## 6. 圧力制御、体積揺らぎ、応力

圧力制御は、NPT の標本化を実現するために体積（または格子ベクトル）を時間発展させる。Parrinello–Rahman 型は格子自由度を動力学変数として扱い、結晶の異方的変形も表現できる。Berendsen 型は緩和的に圧力へ近づけるが、厳密な NPT 分布を与えないことがあるため、目的に応じて使い分ける必要がある。

圧力や応力は、力学量としてはビリアルに基づいて評価される。例えば圧力テンソル $P_{ij}$ は、運動量流束と相互作用由来の項から構成される。直感としては、速度の揺らぎが運動論的圧力を与え、原子間力と相対位置が相互作用由来の寄与を与えると捉えるとよい。応力評価を材料物性へ用いる場合、体積の定義、周期境界条件の扱い、局所応力の定義の曖昧さが結果へ影響し得る点も理解しておく必要がある。



## 7. 周期境界条件と有限サイズの考え方

凝縮系では周期境界条件を用い、無限系を有限セルで近似する。セルをタイル状に敷き詰めた像（イメージ）を暗黙に導入し、境界を越えた相互作用を取り込む仕組みである。これにより表面の影響を抑えられる一方、セルサイズが小さいと自己相関が像を介して混入し、拡散や相転移の挙動が歪む場合がある。

カットオフ半径 $r_c$ を用いる短距離相互作用では、最小像規約により $r_c$ をセルの半分以下に保つことが基本となる。さらに、近接リスト（neighbor list）を用いて力計算を高速化する際、リスト更新頻度とスキン距離の選び方が計算コストと精度に影響する。これらは単なる計算上の工夫ではなく、力の連続性やエネルギーの滑らかさに関わるため、物性評価の安定性にも影響し得る。



## 8. 長距離相互作用と Ewald 系手法

電荷を含む系ではクーロン相互作用が長距離であり、単純なカットオフは大きな誤差を生む。Ewald 和は相互作用を実空間の短距離項と逆空間の長距離項に分解し、双方の収束を改善する方法である。計算量の観点からは、粒子メッシュ Ewald（PME）などが広く用いられ、大規模系で現実的な速度を実現する。

Ewald 系では系の電荷中性や境界条件が重要になる。例えば非中性セルではエネルギーが発散するため、背景電荷で補うなどの仮定が暗黙に入る場合がある。誘電境界の取り方や双極子補正も結果へ影響し得るため、何が仮定されているかを理解したうえで物性へ結びつける姿勢が重要である。



## 9. 原子間ポテンシャルの位置づけ

分子動力学の入力である $U(\mathbf{R})$ を与える方法は大きく三つに分かれる。

1) 古典力場  
経験的な関数形に基づく。高速で大規模計算に適するが、化学反応や電子状態変化の表現は難しい場合が多い。

2) 第一原理由来（力は電子状態計算から得る）  
密度汎関数理論などから各時刻の力を計算する。精度は高いが計算量が大きく、サイズと時間が制約される。

3) 機械学習ポテンシャル  
第一原理データを教師として $U(\mathbf{R})$ を学習する。狙いは第一原理に近い精度と古典力場に近い速度の両立である。

機械学習ポテンシャルは、立場としては 1) の力場でありながら、パラメータを 2) のデータから同定する点に特徴がある。したがって、学習データの範囲内で強いが、範囲外での保証は学習設計と検証方法に依存するという性質を持つ。



## 10. 機械学習ポテンシャルの基本式

多くの機械学習ポテンシャルは、全エネルギーを原子ごとの寄与の和として表す。
$$
E(\mathbf{R},\mathbf{Z})=\sum_{i=1}^{N}\varepsilon_i(\mathcal{N}_i)
$$
ここで $\mathbf{Z}$ は元素種の集合、$\mathcal{N}_i$ は原子 $i$ の近傍環境であり、カットオフ半径以内の相対配置から作られる。エネルギーが得られれば、力は勾配として
$$
\mathbf{F}_i=-\nabla_{\mathbf{r}_i}E(\mathbf{R},\mathbf{Z})
$$
で与えられる。したがって、エネルギーを微分可能な形で学習することは、力の整合性（保存力）を満たすうえで重要である。

学習では、参照データ（多くは第一原理計算）に対して、エネルギー・力・応力の誤差を同時に最小化する損失関数が用いられることが多い。
$$
\mathcal{L}
= w_E\|E-E^{\mathrm{ref}}\|^2
+ w_F\frac{1}{3N}\sum_i\|\mathbf{F}_i-\mathbf{F}_i^{\mathrm{ref}}\|^2
+ w_\sigma \|\boldsymbol{\sigma}-\boldsymbol{\sigma}^{\mathrm{ref}}\|^2
$$
力はデータ数が多く、局所環境の情報を強く含むため、力を損失に含めることがデータ効率を高める場合が多い。ただし、重み $w_E,w_F,w_\sigma$ の選び方で学習の性格が変わるため、目的物性に対してどの項を重視するかを意識する必要がある。



## 11. 対称性と表現の要請

原子間ポテンシャルは、物理的に満たすべき対称性を持つ。少なくとも以下が必要である。

- 並進不変性  
  全原子を同じだけ平行移動してもエネルギーは変わらない。

- 回転不変性  
  系全体を回転してもエネルギーは変わらない。力は回転に従って回転する必要がある。

- 同種原子の置換不変性  
  同一元素のラベル交換でエネルギーは変わらない。

古い世代の方法では、これらを満たす手作りの記述子（例：原子間距離、角度、SOAP など）を構成し、その上で回帰（カーネル法、線形回帰など）を行う設計が多かった。近年は、回転群に対して等価変換性を満たすニューラルネットワークを用い、ベクトルや高階テンソルの情報を保持したまま学習する手法が発展している。等価変換性を満たすとは、入力を回転すると中間表現も同じ規則で回転し、その結果としてエネルギー不変、力が共変で出力されるように設計されていることを意味する。



## 12. モデル設計の主要系統

機械学習ポテンシャルは、表現の作り方と相互作用の集約の仕方で性格が変わる。代表的な系統を整理する。

### 12.1 記述子とカーネル法

GAP は SOAP などの記述子を用い、ガウス過程回帰によりエネルギーを近似する枠組みである。記述子の設計が物理直観と結びつきやすく、少量データでも高精度を狙える一方、計算規模や実装の複雑さは用途により変わる。局所環境の類似度という観点から、学習データ分布の理解が比較的しやすいという利点もある。

### 12.2 ローカルニューラルネットワークとメッセージパッシング

原子をノード、近接関係をエッジとするグラフ表現を用い、近傍から情報を集約することで多体効果を表現する。メッセージパッシングは表現力が高いが、反復回数や通信が計算性能へ影響する場合がある。化学結合の再配列や多様な局所環境を扱いやすいという利点があり、材料・分子の双方で広く用いられている。

### 12.3 等価変換性モデル

NequIP は $E(3)$ 等価変換性を用いて高いデータ効率を示した代表例である。回転不変量だけでなく、回転に従って変換する特徴量を持つことで、幾何情報を失いにくい設計になっている。Allegro は厳密にローカルな設計と等価変換性を組み合わせ、大規模系での並列性を強く意識した構成を取る。

MACE は原子中心の局所展開（角運動量チャネル）を活用し、多様な領域で強い性能が報告されている。等価変換性は数学的には群表現に基づくが、初学者にとっては、回転しても物理法則が同じであることを学習器へ埋め込む工夫であると理解するとよい。

### 12.4 事前学習型の汎用モデル

M3GNet は広い元素空間へ適用できる汎用的モデルの一つであり、大規模データベースから学習して多様な材料へ適用する方向性を示した。CHGNet は材料データベース由来の軌跡データで事前学習し、エネルギー・力・応力に加えて磁気モーメント情報も取り込む設計を含む点が特徴である。事前学習型は、個別系の少量データでの追加学習（転移学習）と相性が良い場合があるが、どの物性がどの程度再現できるかはモデルと系に依存するため、利用目的に沿った検証が必要である。



## 13. 学習データ設計の考え方

機械学習ポテンシャルの成否は、モデルよりも学習データの質と分布に強く依存する場合が多い。これは、ポテンシャルが本質的に $U(\mathbf{R})$ の近似であり、観測していない領域の形を一意に決められないためである。

学習データは、単に平衡構造だけを集めるのではなく、分子動力学が訪れ得る非平衡配置を含める必要がある。例えば、熱揺らぎで局所的に短い距離が現れる、欠陥近傍で結合が歪む、相転移近傍で構造が揺れる、といった配置が欠けると、実行時に不自然な力が生じて計算が破綻し得る。

そこで、第一原理分子動力学の短い軌跡、温度を変えたサンプリング、ランダム変位を加えた構造、弾性変形や体積変化、NEB 画像のような遷移状態近傍など、異なる生成方法を組み合わせて多様性を担保する設計が行われる。さらに、学習モデルを暫定的に作り、そのモデルで探索した軌跡から不確かさが大きい配置を抽出して参照計算を追加する反復的な戦略（能動学習）が有効な場合が多い。



## 14. 不確かさと外挿の扱い

機械学習ポテンシャルは、学習領域では高精度でも、学習領域外で突然破綻することがある。これは、誤差が滑らかに増えるとは限らず、力の符号が変わるなどの形でダイナミクスに直ちに影響するためである。したがって、外挿に対して何らかの警報を持つことが重要である。

不確かさの評価には、複数モデルのアンサンブルの分散を用いる方法、ベイズ的近似、距離尺度（学習データの局所環境空間での近さ）を用いる方法などがある。GAP のようなカーネル法は不確かさ推定が比較的自然に導入できる場合があり、ニューラルネットワーク系でもアンサンブル学習により実用的な指標が得られる場合が多い。いずれにせよ、不確かさ推定は万能ではなく、物理量の再現性を通じた検証と併用する姿勢が必要である。



## 15. 何を再現すべきかという観点

機械学習ポテンシャルはエネルギーと力を再現するが、目的は物性の再現である。したがって、参照データとの誤差指標だけでなく、得たい物性が再現されるかを明確にして評価する必要がある。

固体材料で重要になりやすいのは、格子定数、弾性定数、フォノン分散、熱膨張、欠陥形成エネルギー、拡散係数、相転移温度付近の自由エネルギー差などである。液体やアモルファスでは、動径分布関数 $g(r)$、配位数分布、自己拡散係数、粘性、構造緩和時間などが重要になる。反応系では、反応座標に沿った障壁や遷移状態近傍の力の精度が支配的となるため、反応経路のデータが学習へ含まれているかが特に重要である。



## 16. 計算量とスケーリングの考え方

第一原理分子動力学では、各ステップで電子状態計算が必要になり、系サイズ $N$ に対して重い計算量が生じる。一方、機械学習ポテンシャルは、多くの場合ローカル近傍（カットオフ内）に基づくため、密度一定の大規模系で概ね $O(N)$ に近いスケーリングを示しやすい。

ただし、等価変換性モデルは角運動量チャネルやテンソル積を扱うため、同じ近傍数でも定数因子が大きくなる場合がある。また、メッセージパッシングの回数が増えると通信が増え、並列効率が落ちることがある。Allegro のようにローカル性を強くし並列性を意識した設計が注目されるのは、この計算機的制約が物性計算の到達範囲を決めるからである。



## 17. 比較表

| 方法 | 力の出し方 | 精度の源泉 | 計算規模と時間 | 主な強み | 主な制約 |
|---|---|---|---|---|---|
| 古典力場 | 解析的関数形から $-\nabla U$ | 経験パラメータ | 非常に大規模・長時間 | 高速で安定 | 化学変化や電子状態の影響を表しにくい場合がある |
| 第一原理分子動力学 | 電子状態計算から力 | 量子計算 | 小規模・短時間 | 高い信頼性 | 計算量が大きい |
| 機械学習ポテンシャル | 学習した $E$ の勾配 | 第一原理データ | 大規模・長時間を狙える | 精度と速度の両立を狙う | 学習領域外での保証は学習設計と検証に依存 |



## 18. 材料研究での使い方の整理

材料研究では、相転移、拡散、欠陥、アモルファス化、界面反応など、長時間・大規模が本質となる現象が多い。第一原理分子動力学だけでは到達が難しい領域を、機械学習ポテンシャルにより探索し、重要部分を第一原理で精査するという役割分担がしばしば有効である。

一方で、機械学習ポテンシャルは万能な量子計算の代替ではない。例えば、電子励起、電荷移動の長距離効果、強相関、スピン状態の切り替わりなどが支配的な現象では、エネルギー面の形が単純な局所関数として表現しにくい場合がある。CHGNet のように追加情報を取り込む設計はこの方向への一つの試みであるが、何が表現できているかを系ごとに判断する必要がある。



## 19. 注意点の書き方としての整理

機械学習ポテンシャルを用いた分子動力学では、計算が最後まで走ることと、物理的に正しいことは同義ではない。例えば、温度が制御されていても、構造が不自然に崩壊していないか、拡散が異常に速くないか、応力が不安定に振動していないか、といった観点で挙動そのものを点検する必要がある。

また、参照データがあるなら、短い時間窓でも第一原理分子動力学と並べて、構造統計（$g(r)$ など）や短時間の振動スペクトルが整合するかを確認するのが有効である。ここで重要なのは、単一の指標だけで良否を決めず、エネルギー、力、構造、ダイナミクスを複数の角度から整合させる姿勢である。



## 20. まとめと展望

分子動力学は、ポテンシャルエネルギー面 $U(\mathbf{R})$ を与えることで、原子配置の時間発展を計算する枠組みである。機械学習ポテンシャルは、第一原理データから $U(\mathbf{R})$ を学習し、第一原理に近い精度で大規模・長時間の計算へ到達する道を拡げている。

今後は、等価変換性モデルの発展と計算機実装の洗練により、より大規模な相転移や欠陥ダイナミクスが現実的になっていくと考えられる。同時に、外挿の検出、不確かさの定量、長距離相互作用や電子自由度を含む拡張など、信頼性を体系的に高める方向が重要になり、材料研究では第一原理計算との役割分担を意識した運用がいっそう求められると考えられる。


## 参考文献

- L. Zhang et al., Deep Potential Molecular Dynamics: A Scalable Model with the Accuracy of Quantum Mechanics, Phys. Rev. Lett. 120, 143001 (2018). https://link.aps.org/doi/10.1103/PhysRevLett.120.143001
- S. Batzner et al., E(3)-equivariant graph neural networks for data-efficient and accurate interatomic potentials, Nature Communications 13, 2453 (2022). https://www.nature.com/articles/s41467-022-29939-5
- A. Musaelian et al., Learning local equivariant representations for large-scale atomistic dynamics, Nature Communications 14, 579 (2023). https://www.nature.com/articles/s41467-023-36329-y
- C. Chen et al., A universal graph deep learning interatomic potential for the periodic table, Nature Computational Science 2, 718–728 (2022). https://www.nature.com/articles/s43588-022-00349-3
- B. Deng et al., CHGNet as a pretrained universal neural network potential for charge-informed atomistic modelling, Nature Machine Intelligence 5, 1031–1043 (2023). https://www.nature.com/articles/s42256-023-00716-3
- D. P. Kovács et al., Evaluation of the MACE force field architecture, J. Chem. Phys. 159, 044118 (2023). https://pubs.aip.org/aip/jcp/article/159/4/044118/2904837/evaluation-of-the-mace-force-field-architecture
- A. P. Bartók et al., Gaussian Approximation Potentials: The Accuracy of Quantum Mechanics, without the Electrons, Phys. Rev. Lett. 104, 136403 (2010). https://link.aps.org/doi/10.1103/PhysRevLett.104.136403
- GROMACS Reference Manual, Molecular Dynamics algorithms. https://manual.gromacs.org/documentation/nightly/reference-manual/algorithms/molecular-dynamics.html
- LAMMPS Documentation, Nosé–Hoover integrators (fix nvt). https://docs.lammps.org/fix_nh.html
- 奥村久士, 分子動力学シミュレーションにおける温度・圧力制御. https://okweb.ims.ac.jp/molsim1-4.pdf
- 安藤, 分子動力学計算の拡張に向けた機械学習応用の動向（講演資料）. https://ccse.jaea.go.jp/meeting/CCSE_WS30/PDF/Ando.pdf
