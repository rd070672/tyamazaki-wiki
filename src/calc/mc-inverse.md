# インバース MC 法（Inverse / Reverse Monte Carlo）入門

#### 参考にしたドキュメント（日本語）

- 日産アーク株式会社「リバースモンテカルロ (RMC) 法による非晶質材料の三次元構造解析」サービス紹介ページ  
- リガク株式会社「RMC法（Reverse Monte-Carlo RMC 法）」SmartLab Studio II PDF解析：RMC Method 解説ページ  
- 岡田 勲，「計算機実験 ― 逆モンテカルロ法（RMC法）による溶融塩の構造解析」，工業物理化学／電気化学誌 解説記事  
- 小原 真司，「回折実験と構造モデリングによるガラスの構造解析」，化学会誌・特集「ガラスの構造解析」解説記事  
- 日本結晶学会誌 特集記事「逆モンテカルロモデリングとガラスの構造解析」  
- 千葉大学アモルファス研究グループ「RMC計算用プログラム」および Web メモ（RMC法の実務的な解説）


## 1. インバース MC 法とは何か

- 通常のモンテカルロ（MC）法は  
  「ハミルトニアン／ポテンシャルが既知 → その平衡状態をサンプリングする『順問題』」の道具。
- インバース MC / Reverse Monte Carlo（RMC）法はその逆で、  
  「実験データ（回折・PDF・EXAFS・SRO など）が与えられているときに、  
  それを再現する構造モデルや有効相互作用を求める『逆問題』」を MC で解く手法。
- 材料・ガラス・液体分野では特に：
  - 原子配置を調整して回折・PDF を再現する Reverse Monte Carlo (RMC)  
  - 短距離規則性などから有効相互作用を推定する inverse MC  
  といったバリエーションが使われている。


## 2. 基本的な考え方：順問題 vs 逆問題

### 2.1 順方向 MC（標準的な MC）

1. ポテンシャル／ハミルトニアン $H(\mathbf{x})$ が既知。
2. Metropolis 法等で構造 $\mathbf{x}$ をサンプリング。
3. サンプリングした構造から構造因子・エネルギー・相関関数などを評価。

→ 「ポテンシャル → 構造・物性」を計算する。

### 2.2 インバース / Reverse MC

1. 実験で得られた観測量（例：構造因子 $S(Q)$、PDF、EXAFS、SRO 係数など）をターゲットとする。
2. MC の「受理判定」を、エネルギーではなく  
   「実験値とのずれ（コスト関数）」に基づいて行う：
   $$
     \chi^2(\mathbf{x}) 
     = \sum_i \frac{(O_i^{\text{calc}}(\mathbf{x}) - O_i^{\text{exp}})^2}{\sigma_i^2}
   $$
3. 原子座標・サイト占有・相互作用パラメータをランダムに更新し、  
   $\chi^2$ が小さくなる方向へ MC 探索を行う。
4. 最終的に $\chi^2$ が十分小さいモデルを  
   「実験データと整合的な構造／相互作用」とみなす。

→ 「データ → 構造／ポテンシャル」を求める逆問題として MC を使う、というのがポイント。


## 3. タイプ別の整理

### 3.1 構造再構成型：Reverse Monte Carlo (RMC)

- 目的：
  - 原子座標 $\{\mathbf{r}_i\}$ を直接変数として、
  - 実験の回折・PDF・EXAFS などを再現する 3D 構造モデルを得る。
- 典型的な手順（ガラス・アモルファス例）：
  1. 組成・密度から決まる数の原子を、セルの中にランダム配置（あるいは MD から初期構造を用意）。
  2. その構造から $S(Q)$ や $G(r)$ を計算。
  3. 実験値とのずれから $\chi^2$ を定義。
  4. 原子を少し動かした構造を提案し、新しい $\chi^2$ を計算。
  5. Metropolis ルール（$\Delta\chi^2$ に基づく受理・棄却）で構造を更新。
  6. これを繰り返し、$\chi^2$ の収束した構造を採用する。

- 特徴：
  - ポテンシャルを仮定せず「実験データそのもの」から構造を復元できる。
  - 一方で、同じデータを再現する構造は多数ありうるため、
    配位数制限・最短距離制約・結合角分布などの物理的制約を併用することが重要。

### 3.2 有効ポテンシャル決定型：インバース MC

- 目的：
  - 目標とする相関関数（ペア相関、SRO 係数など）を与え、
  - それを再現するような有効対ポテンシャル $V(r)$ や結合パラメータを求める。
- やり方のイメージ：
  - ポテンシャルのパラメータ $\boldsymbol{\theta}$ を変数とし、
  - そのポテンシャルで MC を回して得た相関関数 $g^{\text{calc}}(r;\boldsymbol{\theta})$ と、
    実験 $g^{\text{exp}}(r)$ の差を最小化する。
  - 合金の SRO 係数を再現するサイト占有配置を作り、その過程から有効対相互作用を推定する  
    inverse MC もこのカテゴリに含まれる。


## 4. 事例：モンテカルロで結晶・ガラス構造を逆解析する

### 4.1 回折・PDF データからガラス／結晶を再構成

- ガラス：  
  - X線／中性子回折から得られた構造因子 $S(Q)$ と PDF を同時にフィットし、  
    ネットワーク構造（配位多面体のつながり方、空隙構造など）を 3D モデルとして得る。
- 結晶性材料：  
  - Bragg ピーク（長距離秩序）＋全散乱（短距離秩序）を同時に扱う RMCProfile などにより、
    局所構造のゆらぎ・格子欠陥・ナノスケールの不均一性をモデリングする。

### 4.2 SRO から合金のサイト占有を推定

- 合金の短距離規則性（Warren–Cowley 係数など）をターゲットに、
  - 格子上の A/B 占有を交換 MC で更新し、
  - 実験 SRO を再現する配置を生成する inverse MC 法が使われる。
- そこから、
  - 「どの原子がどの元素の近傍を好むか」
  - 「クラスター形成傾向はどの程度か」  
  など、局所秩序の 3D イメージを得ることができる。

### 4.3 RMC + エネルギー（ハイブリッド型）

- 純粋な RMC では、データには合うが局所的に非物理的な構造が出てくることがある。
- そこで、
  - DFT や古典ポテンシャルから得たエネルギー・力も同時に評価し、
  - 「データ適合 + エネルギー最小化」を両立させるハイブリッド手法（MD-RMC, FEAR など）が提案されている。
- これにより、
  - 実験と整合的で、かつエネルギー的にも妥当な構造モデルを得やすくなる。


## 5. アルゴリズムの擬似的な流れ（RMC 型）

1. 実験データ $ \{ O_i^{\text{exp}} \}$ を用意（回折、PDF、EXAFS など）。
2. 初期構造 $\mathbf{x}^{(0)}$ を用意（ランダム・MD 結果・理想結晶からの揺らぎなど）。
3. 構造から計算値 $O_i^{\text{calc}}(\mathbf{x})$ を求める。
4. コスト関数 $\chi^2(\mathbf{x})$ を計算。
5. 原子の小さな移動／サイト交換などで候補構造 $\mathbf{x}'$ を作る。
6. 新しい $\chi^2(\mathbf{x}')$ を計算し、$\Delta\chi^2 = \chi^2(\mathbf{x}') - \chi^2(\mathbf{x})$ を評価。
7. Metropolis ルールに基づき受理／棄却。
8. 収束するまで 3–7 を繰り返す。


## 6. 利点と注意点

### 6.1 利点

- ポテンシャルが未知でも「実験データさえあれば」構造モデルを構築できる。
- X線・中性子・XAFS・NMR など、異なる実験データを統合的に扱える。
- ガラス・液体・強乱れ結晶など、  
  伝統的な結晶学手法が適用しにくい系にとくに有効。

### 6.2 注意点・限界

- 解の非一意性：
  - 同じデータを再現する構造は複数あり得る。
  - 物理的制約やエネルギー条件を入れないと、「一番無秩序な構造」に寄りやすい。
- ノイズへの過剰フィット：
  - 測定誤差までフィットしてしまうと、かえって非物理的な構造になることがある。
- 計算コスト：
  - 大きなスーパーセルと複数データセットを同時フィットすると、1 ステップあたりの計算が重くなる。


## 7. 材料インフォマティクスとの接点

- RMC / inverse MC で得た構造モデルは、
  - 局所環境記述子（SOAP, ACSF）、
  - トポロジカル指標（パーシステントホモロジー）、
  - ネットワーク解析指標  
  などに変換して ML の特徴量として扱える。
- 「実験 → 構造モデリング（RMC） → 特徴量化 → 物性予測（ML）」という流れを作ることで、
  - 実験駆動・データ駆動型の材料設計サイクルの中核技術として位置づけることができる。
