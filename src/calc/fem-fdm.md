# 有限要素・有限差分計算：FEM と FDM の原理

#### 参考ドキュメント
- [中島、有限要素法入門](http://nkl.cc.u-tokyo.ac.jp/FEM/01-FEMintro.pdf)
- [Comsol、有限要素法 (FEM)](https://www.comsol.jp/multiphysics/finite-element-method?parent=physics-pdes-numerical-042-62)

---

## 概要
- 偏微分方程式（PDE）を数値的に解く代表的な方法として  
  有限差分法 (FDM: Finite Difference Method)と  
  有限要素法 (FEM: Finite Element Method)が広く用いられている。
- どちらも「連続な PDE を、離散化して連立一次方程式に落とす」という意味では同じだが、
  - FDM：空間を格子点で離散化し、「微分 ≒ 差分」で直接近似する手法
  - FEM：領域を要素に分割し、基底関数（形状関数）で場を展開し、弱形式に基づいて方程式を組み立てる手法
- 幾何形状・物性の複雑さ、境界条件の種類、解きたい PDE のタイプに応じて使い分けられる。

## 有限差分法 (FDM) の原理

### 基本アイデア
- PDE に含まれる微分を、差分近似で置き換える：
  - 1 次微分：
    $$
      \frac{\partial u}{\partial x}(x_i)
      \approx \frac{u_{i+1} - u_{i-1}}{2\Delta x}
    $$
  - 2 次微分：
    $$
      \frac{\partial^2 u}{\partial x^2}(x_i)
      \approx \frac{u_{i+1} - 2u_i + u_{i-1}}{\Delta x^2}
    $$
- これにより、連続方程式（例：$-u''=f$, 拡散方程式、波動方程式など）が、格子点上の連立一次方程式に変換される。

### 空間の離散化
- 計算領域を等間隔または非等間隔の格子点で区切る：
  - 1D：$x_0, x_1, ..., x_N$
  - 2D：$(x_i, y_j)$ の格子点
  - 3D：$(x_i, y_j, z_k)$ の格子点
- 各格子点で未知量（スカラー場・ベクトル場）を定義し、周囲の点との「差分」によって微分を近似。

### PDE の例（ポアソン方程式）
- 1D の例：
  $$
    -\frac{d^2 u}{dx^2} = f(x),\quad 0 < x < L
  $$
- 空間を等間隔 $\Delta x$ で離散化すると、
  $$
    -\frac{u_{i+1} - 2u_i + u_{i-1}}{\Delta x^2} = f_i
  $$
  という形の式が各格子点 $i$ で得られ、  
  全体として三重対角の連立一次方程式になる。

### 時間発展問題への適用
- 拡散方程式・波動方程式など時間依存 PDE では、
  - 空間：差分近似（FDM）
  - 時間：時間差分（Forward Euler, Crank–Nicolson など）
  を組み合わせて、時間発展スキームを構成する。
- 安定性条件（CFL 条件）：
  - 陽解法では $\Delta t/\Delta x^2$ に制約があり、  
    小さな時間刻みが必要になる場合が多い。

### FDM の特徴
- 利点：
  - アルゴリズムが直感的で実装が簡単（特に直交座標＋単純な領域）。
  - 行列構造が単純（バンド行列／スパースな構造）になりやすい。
- 欠点：
  - 複雑な形状・曲線境界の表現が難しい（「階段状」になりがち）。
  - 材料物性が急激に変化する領域や、局所的な細かいメッシュの導入が難しい。

---

## 有限要素法 (FEM) の原理

### 基本アイデア
- PDE を弱形式（変分形式）に書き換え、  
  試験関数（基底関数）で展開した上で、係数を求める手法。
- 領域を三角形・四角形（2D）、四面体・六面体（3D）などの要素 (element)に分割し、
  各要素ごとに「形状関数 (shape function)」を定義する。

### 弱形式への変換（例：ポアソン方程式）
- PDE：
  $$
    -\nabla^2 u = f \quad \text{in } \Omega
  $$
- 試験関数 $v$ をかけて積分し、部分積分すると：
  $$
    \int_\Omega \nabla u \cdot \nabla v \, d\Omega
    = \int_\Omega f v \, d\Omega
    + \text{境界項}
  $$
- FEM では、解 $u$ を基底関数の線形結合で近似：
  $$
    u_h(\mathbf{x}) = \sum_j U_j \, N_j(\mathbf{x})
  $$
  - $N_j(\mathbf{x})$：各ノードに対応する形状関数
  - $U_j$：ノード値（未知係数）
- 式を代入し、試験関数にも $N_i$ を選ぶことで、  
  係数 $U_j$ についての連立一次方程式：
  $$
    \mathbf{K}\mathbf{U} = \mathbf{F}
  $$
  を得る。
  - $\mathbf{K}$：剛性行列
  - $\mathbf{U}$：未知のノード値ベクトル
  - $\mathbf{F}$：右辺ベクトル

### 要素と形状関数
- 要素メッシュ：
  - 2D：三角形要素・四角形要素
  - 3D：四面体要素・六面体要素
- 各要素内で、$u_h$ を線形・2 次・3 次などの多項式で補間：
  - 線形三角形要素：頂点 3 点の値から内点を一次補間。
  - 2 次要素：辺の中点ノードも持ち、より滑らかな近似。
- 形状関数の性質：
  - 各ノードで「そのノードの形状関数は 1、それ以外は 0」。
  - 要素内で連続・多項式、要素境界で隣接要素と連続。
  - これにより、全領域で連続な近似解 $u_h$ が得られる。

### 行列の組み立て
- 各要素 e について、局所剛性行列 $\mathbf{K}^e$、局所荷重ベクトル $\mathbf{F}^e$ を計算：
  $$
    K^e_{ij} = \int_{\Omega_e} \nabla N_i \cdot \nabla N_j \, d\Omega,
    \quad
    F^e_i = \int_{\Omega_e} f N_i \, d\Omega
  $$
- 要素ごとに得られた $\mathbf{K}^e, \mathbf{F}^e$ を、
  アセンブル（assemble）して全体行列 $\mathbf{K}, \mathbf{F}$ を構成。
- 境界条件（Dirichlet/Neumann/Robin）を反映して、線形方程式を解く。

### FEM の特徴
- 利点：
  - 複雑な形状・曲線境界・穴あき領域に柔軟に対応できる。
  - 材料物性が場所によって変わる場合（異方性・複合材料）に強い。
  - 高次要素・適応メッシュ（細かさを局所的に変える）が導入しやすい。
  - 変分形式に基づくため、エネルギー保存・数値安定性の観点で扱いやすい。
- 欠点：
  - 理論（弱形式・機能解析）の理解と実装がやや難しい。
  - 行列組み立て・メッシュ生成などの前処理が必須（ライブラリを使うのが普通）。

---

## FEM と FDM の比較・使い分け

### 幾何形状
- FDM：
  - 直交座標・矩形領域には非常に向いている。
  - 複雑形状では、階段状の境界や座標変換など工夫が必要。
- FEM：
  - 任意形状の領域、曲線・曲面境界に自然に対応可能。

### 物性・係数
- FDM：
  - 係数が均一・単純な PDE では実装が簡単。
  - 係数が場所依存・テンソル依存（異方性）になるとスキームが複雑化。
- FEM：
  - 係数が空間的に変化しても、弱形式に自然に組み込める。
  - 構造力学・電磁場・熱・流体など、多様な分野で統一的に扱いやすい。

### 実装・計算資源
- FDM：
  - コード量が少なくて済むことが多い。
  - 規則格子なら行列構造が単純で、大規模並列化もしやすい。
- FEM：
  - メッシュ生成・行列組み立てなどが必要だが、  
    COMSOL, FEniCS, deal.II などのライブラリにより実務ではかなり自動化されている。

### 典型的な用途
- FDM：
  - 伝熱、拡散、波動などの単純形状 PDE、教育・プロトタイプコード、  
    格子ボルツマン・FD 系 CFD など。
- FEM：
  - 構造解析（固体力学）、電磁界解析、熱・流体、連成場解析など、  
    工学的な複雑系の主力手法。

---

## PDE 解法フレームワークとの対応

- COMSOL Multiphysics：
  - 基本的に FEM ベース。GUI でメッシュ・境界条件・材料設定が可能。
  - 汎用 PDE インターフェイスで、自作方程式も FEM で解ける。
- FEniCS / Firedrake：
  - Python / C++ ベースの FEM ライブラリ。弱形式を記述すると自動で行列を生成。
- FiPy：
  - Python ベースの FDM/Finite Volume 系 PDE ソルバー。
- 自作コード：
  - FDM：教育用・特定用途向けに 1D/2D の簡易コードを書きやすい。
  - FEM：メッシュ生成や要素実装が大変だが、特定用途に特化したコードには有効。

