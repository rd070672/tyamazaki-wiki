# サンプリング理論と計測デジタル化の基本  
サンプリングと量子化は、DAQやデジタルオシロスコープが信号を数値へ変換する根幹である。$f_{s}>2f_{\max}$ を満たしていても、アナログ帯域外成分が残っていれば折り返しや見かけのスペクトルが現れるため、前段の帯域制限とレンジ設計まで含めて体系的に扱う必要があるのである。

## 1. 用語

- サンプリング周波数 $f_{s}$  
  連続時間信号を離散化するときの標本化レートである。$f_{s}$ を上げるほどナイキスト周波数 $f_{N}$ が上がり、折り返しの危険帯域を高周波側へ押し上げられるが、アナログ帯域外成分が残っていれば折り返し自体は回避できない。

- サンプリング周期 $T_{s}=1/f_{s}$  
  サンプル間隔である。時間分解能の基礎量であり、過渡波形の立ち上がりを観測したい場合は、対象の最短時間スケールに対し $T_{s}$ が十分小さい必要がある。

- ナイキスト周波数 $f_{N}=f_{s}/2$  
  離散化後に一意に表現できる周波数の上限である。$f_{N}$ を超える成分は、前段で抑圧しない限り観測帯域へ折り返す。

- 帯域制限（band-limited）  
  ある有限周波数 $B$ を超えてスペクトルがゼロ（あるいは無視できるほど小さい）である性質である。サンプリング定理の前提であり、実測ではアンチエイリアスフィルタ等により物理的に近似する。

- 折り返し（aliasing）  
  $f_{N}$ を超える成分が離散化によって $[0,f_{N}]$ に写り込む現象である。折り返しはサンプリング後に分離不可能であり、対策はサンプリング前の帯域制限に限られる。

- アンチエイリアスフィルタ  
  サンプリング前に $f_{N}$ 以上の成分を十分減衰させるアナログフィルタである。$f_{s}>2f_{\max}$ を満たしていても、帯域外のノイズやスプリアスが残る限り必須である。

- 遷移帯域（transition band）  
  フィルタが通過帯域から阻止帯域へ移る周波数範囲である。遷移帯域が狭いほど急峻なフィルタが必要になり、位相特性・群遅延・リンギングなどの副作用が増えやすい。

- 量子化（quantization）  
  連続値（アナログ電圧）を有限個の離散レベルへ丸め込む操作である。量子化は不可逆であり、微小信号では量子化誤差が雑音として観測される。

- 分解能（ビット深度）$N$  
  ADC が表現できるレベル数 $2^{N}$ を決める量である。理想条件では $N$ が大きいほど量子化雑音が下がり、SNR はおおむね $6.02N+1.76$ dB に従うが、実機では前段雑音や非線形で ENOB が低下する。

- LSB（Least Significant Bit）  
  最下位ビットに対応する量子化ステップ幅である。フルスケール範囲 $V_{\mathrm{FS}}$ に対して $\Delta=V_{\mathrm{FS}}/2^{N}$ と定義され、入力換算雑音や微小信号分解の目安になる。

- フルスケール $V_{\mathrm{FS}}$  
  ADC が無歪で扱える入力範囲である（多くはピークツーピーク、あるいは±レンジで規定される）。レンジが広いほど飽和しにくいが、同じ $N$ なら LSB が大きくなり微小信号には不利である。

- クリッピング（飽和）  
  入力が $V_{\mathrm{FS}}$ を超えて波形が上下端で切られる非線形歪みである。高調波や広帯域成分を人工的に生成し、スペクトル解釈を破壊するため、まず排除すべき異常である。

- 量子化雑音  
  量子化誤差に由来する見かけの雑音である。理想一様量子化では誤差が $[-\Delta/2,\Delta/2]$ に一様分布すると仮定して $e_{\mathrm{rms}}=\Delta/\sqrt{12}$ を与え、白色雑音に近い形で帯域内へ分布するとみなす。

- SNR  
  信号電力と雑音電力の比である。測定では帯域幅の定義に依存し、同じ系でも帯域制限（アナログ／デジタル）により SNR が変わるため、評価帯域を固定して扱う必要がある。

- SINAD  
  信号に対する（雑音＋歪）成分の比である。ADC の実力を表しやすく、量子化雑音だけでなく非線形歪（高調波、スプリアス）も含む点で SNR より厳しい指標である。

- ENOB  
  SINAD を理想 ADC の量子化性能へ換算した有効ビット数である。$\mathrm{ENOB}=(\mathrm{SINAD}-1.76)/6.02$ がよく用いられ、データシート上の「実質分解能」を比較するのに有用である。

- オーバーサンプリング（oversampling）  
  必要帯域 $B$ に対して過剰に高い $f_{s}$ でサンプリングすることである。白色雑音支配で適切なデジタルLPFとデシメーションを行うと、帯域内雑音が低下し SNR が改善する。

- デシメーション（decimation）  
  低域通過フィルタで帯域を制限した後にサンプルレートを間引く処理である。前段の低域化が不十分だと、デシメーション自体がデジタル領域の折り返しを生むため、フィルタと一体の設計が必要である。

- デジタルフィルタ  
  離散データに対する周波数選別（LPF/HPF/BPF/ノッチ等）である。帯域内雑音は下げられるが、サンプリング時点で混入したアナログ起源の折り返しは除去できない。

- 記録長（record length）$N_{\mathrm{rec}}$  
  取得するサンプル点数である。観測時間 $T_{\mathrm{obs}}=N_{\mathrm{rec}}/f_{s}$ を決め、FFT の周波数分解能にも直結する。

- 周波数分解能 $\Delta f$  
  FFT のビン幅であり、$\Delta f=f_{s}/N_{\mathrm{rec}}=1/T_{\mathrm{obs}}$ である。$\Delta f$ を細かくするために $N_{\mathrm{rec}}$ を増やすと観測時間が伸びる一方、設定の都合で $f_{s}$ を下げると折り返しリスクが増える場合がある。

- ジッタ（sampling jitter）  
  サンプリング時刻の揺らぎである。高周波ほど電圧誤差へ変換されやすく、近似的に $v_{\mathrm{err,rms}}\approx 2\pi f A\,\sigma_{t}$（$A$ は振幅、$\sigma_{t}$ は時刻揺らぎRMS）として SNR を制限する。

- 時間軸精度（timebase accuracy）  
  クロック周波数の絶対誤差（ppm）や温度ドリフトを含む時間基準の精度である。長時間観測や狭帯域解析では周波数軸のずれや位相の累積誤差として現れるため、外部基準（10 MHz など）同期の要否を判断する材料になる。


## 2. サンプリング定理

連続時間信号 $x(t)$ が帯域 $B$ に制限されているとする。すなわちフーリエ変換 $X(f)$ が
$$
X(f)=0\quad (|f|>B)
$$
を満たすとき、サンプリング周波数 $f_{s}$ が
$$
f_{s}>2B
$$
であれば、標本列 $x[n]=x(nT_{s})$ から $x(t)$ を一意に再構成できる。

理想再構成は sinc 補間で与えられる：
$$
x(t)=\sum_{n=-\infty}^{\infty} x[n]\ \mathrm{sinc}\!\left(\frac{t-nT_{s}}{T_{s}}\right),\qquad
\mathrm{sinc}(u)=\frac{\sin(\pi u)}{\pi u}
$$

ここで重要なのは、帯域制限は数学的前提であり、実測信号はノイズ・高調波・スイッチングスプリアスなどによりしばしば $B$ が曖昧である点である。したがって $f_{s}>2f_{\max}$ は必要条件であるが、前段で $f_{N}$ を超える成分を十分に抑える条件まで含めなければ、観測スペクトルの解釈が崩れるのである。



## 3. 折り返し（aliasing）の数理

連続時間信号のスペクトル $X(f)$ を $f_{s}$ でサンプリングすると、周波数領域ではスペクトルが $f_{s}$ 周期で複製されて重なる。複製は
$$
X_{s}(f)=\frac{1}{T_{s}}\sum_{k=-\infty}^{\infty} X(f-kf_{s})
$$
の形で表され、$|f|\le f_{N}$ の観測域において複数の $k$ 成分が重なれば折り返しが発生する。

単一周波数 $f_{0}$ の成分は、観測帯域内では
$$
f_{\mathrm{alias}}=\left|f_{0}-k f_{s}\right|\qquad (k\in\mathbb{Z})
$$
の周波数へ現れる。ここで $f_{\mathrm{alias}}\le f_{N}$ となる $k$ が選ばれ、実際の高周波成分が低周波へ写り込む。

折り返しは、サンプリング後のデータから完全に除去できない。なぜなら、折り返しは「異なる周波数成分が同じ離散周波数に重畳された状態」であり、追加情報なしに分離不可能であるからである。したがって折り返し対策は、必ずサンプリング前（アナログ領域）で行う必要があるのである。



## 4. アンチエイリアスフィルタが必須になる理由

サンプリング定理の前提である帯域制限を、実信号に対して物理的に実現する役割がアンチエイリアスフィルタである。理想的には $f_{N}$ を境に完全遮断であるが、実フィルタには遷移帯域があるため、設計は次の関係で決まる。

- 通過帯域端 $f_{p}$
- 阻止帯域端 $f_{s\!b}$（ここでは sampling の $f_{s}$ とは別である）
- 遷移帯域幅 $f_{s\!b}-f_{p}$
- 阻止帯域減衰 $A_{s}$

サンプリングで重要になるのは、$f_{N}$ 以上の成分が観測帯域へ折り返すことを前提に、折り返し寄与が測定系の有効ダイナミックレンジより十分小さくなるよう $A_{s}$ を確保する点である。たとえば、観測帯域内で許容したい折り返し寄与をフルスケールに対して $-D$ dB 以下に抑えるなら、少なくとも
$$
A_{s}\gtrsim D
$$
が必要になる。ここで $D$ はADCと前段ノイズを含む系の有効ダイナミックレンジ（後述）である。

フィルタの群遅延（位相特性）も、時間波形や過渡応答に影響する。時間波形の形状保持（リンギングやオーバーシュート低減）が重要な場合は、振幅特性だけでなく群遅延の平坦性を考慮する必要がある。



## 5. アンチエイリアスフィルタの代表的形状

| フィルタ | 振幅特性の傾向 | 位相・群遅延の傾向 | 適用の考え方 |
|---|---|---|---|
| Bessel | 遷移が緩やか | 群遅延が比較的平坦 | 波形歪みを抑えたい場合に選びやすい |
| Butterworth | 通過帯域が平坦 | 群遅延は平坦ではない | まず扱いやすい標準形として使われる |
| Chebyshev（I型） | 遷移が急峻（通過帯域リップル） | 群遅延のうねりが増えやすい | 周波数選別を強めたい場合に使われる |
| Elliptic | 最も急峻（通過・阻止にリップル） | 位相特性が厳しくなりやすい | 遷移帯域を極小化したい場合に使われる |

フィルタ形状の選択は、(i) 観測したい信号の帯域、(ii) サンプリング周波数の制約、(iii) 目標減衰（折り返し寄与許容）、(iv) 時間波形の形状保持の要求、で決まる。



## 6. DAQとオシロスコープのデジタル化の性格

DAQとオシロスコープは、同じサンプリングでも設計思想が異なることが多い。測定で混乱が生じやすいのは、サンプルレート、アナログ帯域、記録長、表示・演算の設定が独立に変化し、ある条件では折り返しが顕在化する点である。

| 項目 | DAQ（計測モジュール） | デジタルオシロスコープ |
|---|---|---|
| 主目的 | 記録と解析に適した波形・時系列 | 波形の観察とイベント捕捉 |
| 前段帯域 | 目的帯域に合わせたアナログ帯域制限が入ることが多い | 広帯域前段で、条件により折り返しが見えやすい |
| サンプルレート | 設定値がそのまま解析条件になる | 時間軸設定や記録長の選択で実効サンプルレートが変わる場合がある |
| 表示 | 数値が直接解析へ供される | 表示補間・デシメーションにより見かけが変わる場合がある |
| 注意点 | モジュールの内蔵フィルタの仕様確認が重要 | サンプルレート低下時に折り返しが顕在化しやすい |

同一の入力でも、表示モード（高分解能モード、平均化、帯域制限設定など）により見え方が変化し得る。観測の目的がスペクトルなのか過渡なのかを先に決め、必要な帯域制限とサンプルレートと記録長を固定することが重要である。



## 7. 記録長と周波数分解能

FFTで周波数分解能を決める主要因は観測時間 $T_{\mathrm{obs}}$ である。記録点数を $N_{\mathrm{rec}}$ とすると
$$
T_{\mathrm{obs}}=\frac{N_{\mathrm{rec}}}{f_{s}},\qquad
\Delta f=\frac{1}{T_{\mathrm{obs}}}=\frac{f_{s}}{N_{\mathrm{rec}}}
$$
である。

ここで $\Delta f$ を細かくするために $N_{\mathrm{rec}}$ を増やすと、同じ記録長を確保するためにサンプルレートを下げる設定になり、折り返しが顕在化する場合がある。周波数分解能と折り返し抑制は同時に満たす必要がある。



## 8. 量子化とビット深度

ADCは連続値を有限の離散レベルへ写像する。フルスケール範囲を $V_{\mathrm{FS}}$ とし、$N$ ビット量子化のステップ（LSB）を
$$
\Delta=\frac{V_{\mathrm{FS}}}{2^{N}}
$$
とする。理想的な一様量子化で、量子化誤差 $e$ が $[-\Delta/2,\Delta/2]$ に一様分布し、入力と独立とみなせる条件では、量子化雑音のRMSは
$$
e_{\mathrm{rms}}=\frac{\Delta}{\sqrt{12}}
$$
である。

フルスケール正弦波入力を仮定した理想ADCの量子化雑音によるSNRは
$$
\mathrm{SNR}\approx 6.02N+1.76\ \mathrm{dB}
$$
で与えられる。

現実のADCは、熱雑音、基準電圧雑音、非線形（INL/DNL）、クロックジッタ、前段アナログ雑音により理想SNRから低下する。データシートではSNRやSINADが与えられ、そこから有効ビット数 ENOB を
$$
\mathrm{ENOB}=\frac{\mathrm{SINAD}-1.76}{6.02}
$$
で定義することが多い。ここでSINADは歪と雑音を含むため、量子化雑音だけでなく系全体の性能を反映する。



## 9. ダイナミックレンジとレンジ設定

ダイナミックレンジは、最大無歪入力（しばしばフルスケール）とノイズ床の比で決まる。観測帯域幅を $B$ とし、等価入力雑音のPSDが $S_{v}(f)$ で平坦近似できるなら、RMS雑音は
$$
v_{\mathrm{n,rms}}\approx \sqrt{\int_{0}^{B} S_{v}(f)\,df}\approx \sqrt{S_{v}B}
$$
である。したがって帯域制限（アナログLPFやデジタルLPF）により $B$ を絞ることは、SNR改善に直結する。

ただし、帯域外に大きな成分が残っている状態でデジタルLPFだけを適用しても、サンプリング時にすでに折り返して観測帯域へ混入していれば除去できない。帯域制限はサンプリング前に成立させる必要があるのである。



## 10. クリッピングとスペクトルの崩壊

入力がADCの入力範囲を超えるとクリッピング（飽和）が生じる。クリッピングは非線形であり、周波数領域では高調波と広帯域成分を生成するため、FFTでは広範囲にエネルギーが散らばる。とくに微信号の近傍に人工的な成分を作るため、量子化や折り返しより先に、まずクリッピングの有無を排除する必要がある。

クリッピングの確認は、時間波形の上下端の平坦化、ヒストグラムの端への張り付き、FFTの高調波の異常増加などで行う。



## 11. オーバーサンプリングと平均化

オーバーサンプリング比を
$$
\mathrm{OSR}=\frac{f_{s}}{2B}
$$
とする（観測帯域を $B$ とする）。白色雑音が支配的で、適切にデジタルLPFとデシメーションを行うなら、帯域内雑音は概ね $\sqrt{\mathrm{OSR}}$ で低下し、SNRは
$$
\Delta\mathrm{SNR}\approx 10\log_{10}(\mathrm{OSR})\ \mathrm{dB}
$$
だけ改善する。2倍のオーバーサンプリングで約3 dB改善である。

ただし、平均化やデシメーションは、時間分解能や過渡イベントの捕捉能力を下げる場合がある。また、量子化雑音や前段雑音が白色でない場合（1/fやスプリアスが支配的）には、期待通りに改善しない。



## 12. FFTで混乱が生じやすい点

## 12.1 漏れ
有限長観測は窓関数を掛けない限り矩形窓であり、非整数周期信号は周波数ビンへ漏れる（spectral leakage）。窓関数 $w[n]$ を用いることで漏れの形状を制御するが、主ローブ幅とサイドローブ抑圧の交換関係がある。

## 12.2 振幅の校正
窓関数は振幅を縮めるため、コヒーレントゲイン（coherent gain）で補正する必要がある。装置が自動補正する場合もあるが、演算の定義（ピーク、RMS、PSD）を明確にして一致を確認する必要がある。

## 12.3 折り返しとFFT
FFTの表示は離散データの周波数解析である。したがって、サンプリング前に折り返しが混入していれば、FFTはそれを観測帯域内の正当な成分として提示する。スペクトルにおける「測れているように見えるが、実際は折り返しである」という状況は、サンプルレート変更や時間軸変更でピークが不自然に移動することで露呈することが多い。



## 13. サンプリングジッタと時間軸誤差

サンプリング時刻がRMSで $\sigma_{t}$ だけ揺らぐとき、正弦波 $v(t)=A\sin(2\pi f t)$ の微小時間ずれは電圧誤差へ変換される。近似的に
$$
v_{\mathrm{err,rms}}\approx 2\pi f A\,\sigma_{t}
$$
となり、高周波ほど、また振幅が大きいほど影響が増える。これは高周波領域でのSNR低下や位相雑音として観測される。

また、時間軸の絶対精度（ppm）や温度ドリフトは、長時間観測や狭帯域解析で周波数軸のずれとして効く。必要に応じて外部基準（10 MHzリファレンス）同期を用いる。



## 14. 短絡・開放・ダミー負荷・既知信号注入による確認

折り返し、量子化、クリッピング、前段雑音、結合ノイズを切り分けるために、次の手順を固定して再現性を持たせる。

- 短絡（入力を低インピーダンスで接地）
- 開放（入力を浮かせる）
- ダミー負荷（抵抗・容量など既知インピーダンスで終端）
- 既知信号注入（周波数・振幅が校正された信号源）

短絡で見える雑音は主に装置内部（前段・ADC・電源）由来であり、開放で増えるなら環境結合（浮遊容量・EMI）を疑う。既知信号注入でサンプルレートや帯域制限設定を変え、ピーク位置が折り返し規則に従って移動するかを確認することで、折り返しの存在を強く示せる。



## まとめと展望

サンプリング理論は $f_{s}>2B$ を核にするが、計測では帯域外成分が常に存在するため、アンチエイリアスフィルタにより帯域制限を物理的に成立させることが不可欠である。今後は高分解能ADCや高速DAQが一般化するほど、ジッタ・前段帯域・デシメーション設定が支配的になり、装置仕様と解析定義を一体として設計する姿勢がますます重要になると考えられるのである。



## 参考ドキュメント
1. Tektronix, What is Aliasing?（オシロスコープにおける折り返しの説明）  
   https://www.tek.com/en/support/faqs/what-aliasing-and-how-do-i-detect-it-and-fix-it-my-oscilloscope

2. Analog Devices, MT-003: Understand SINAD, ENOB, SNR, THD, THD+N, and SFDR（SNR式、ENOB定義）  
   https://www.analog.com/media/en/training-seminars/tutorials/MT-003.pdf

3. NI, Anti-Aliasing Filters and Their Usage Explained（遷移帯域を含むアンチエイリアス設計の考え方）  
   https://www.ni.com/en/shop/data-acquisition/measurement-fundamentals/analog-fundamentals/anti-aliasing-filters-and-their-usage-explained.html

---

## 参考文献・参考資料
- Tektronix, Be Sure to Capture the Complete Picture（サンプルレート不足による折り返しの記述を含む）  
  https://download.tek.com/document/3GW_17741_4_HR.pdf

- Microchip, Anti-Aliasing, Analog Filters for Data Acquisition Systems（折り返し低減としての前段アナログフィルタの役割）  
  https://ww1.microchip.com/downloads/aemDocuments/documents/MCU08/ApplicationNotes/ApplicationNotes/00699b.pdf

- マクニカ, FFTにおける折り返しノイズ（エイリアス）（日本語）  
  https://www.macnica.co.jp/business/semiconductor/articles/basic/142820/

- A&D, FFTアナライザ入門：エイリアシングと折り返し防止フィルタ（日本語）  
  https://www.aandd.co.jp/products/nvh_analysis/fft/fft01.html

- DigiKey, アンチエイリアシングローパスフィルタの基礎（日本語）  
  https://www.digikey.jp/ja/articles/the-basics-of-anti-aliasing-low-pass-filters

- テクノロジー関連企業資料, AD変換の基礎：アンチエイリアシングフィルター（日本語）  
  https://www.toyo.co.jp/mecha/casestudy/detail/id%3D12892
