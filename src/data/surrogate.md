# サロゲートモデル（Surrogate Model）入門（材料科学・MI向け）

サロゲートモデルとは、計算コストや実験コストの高い評価関数（DFT、MD、FEM、実験評価など）を、安価に評価できる近似モデルで置き換える枠組みである。材料科学では、探索（最適化・逆設計・自律実験）と不確かさ（信頼度）の両方を同時に扱うための基盤技術である。

## 参考ドキュメント
- 日本語：SCSK 技術コラム「サロゲートモデルとベイズ最適化（Kriging/GPRの説明を含む）」
  https://www.scsk.jp/sp/eng-dx/product/pseven/column/tech_column-05.html
- 日本語（プレスリリース）：産総研「材料データを秘匿しながらベイズ最適化を行う材料探索アプリを開発」
  https://www.aist.go.jp/aist_j/press_release/pr2024/pr20241224/pr20241224.html
- 海外（総説）：Deringer et al., Gaussian Process Regression for Materials and Molecules, Chemical Reviews (2021)
  https://pubs.acs.org/doi/10.1021/acs.chemrev.1c00022


## 1. サロゲートモデルとは何か
材料設計変数（組成、プロセス条件、構造特徴量など）を $x$、目的特性（硬さ、磁気特性、電池性能、安定性など）を $y=f(x)$ とする。

高価な真の評価
- $y = f(x)$ ：1回の評価が高価（計算時間・装置時間・試料作製コスト）

サロゲート
- $\hat{y}=\hat{f}(x)$ ：少数のサンプル $(x_i, y_i)$ から学習し、任意の $x$ を高速に推定する

基本式
$$
\hat{f} : x \mapsto \hat{y}, \quad \hat{y}\approx f(x)
$$

サロゲートは「最適化」や「大量イテレーション（探索・感度解析・UQ）」の計算量を劇的に減らすことが狙いである。


## 2. 材料科学で現れる“高価な関数”の例
- 第一原理計算：形成エネルギー、磁気異方性、バンドギャップ、弾性定数
- 分子動力学：拡散、粘性、熱伝導、構造緩和の時間発展
- マルチフィジックス：電磁・熱・応力の連成、コア損失、デバイス設計
- 実験：合成→評価のサイクル（試料作製と計測が支配的に遅い）


## 3. 入力表現（特徴量設計）の基本
サロゲートの性能は、入力 $x$ の表現に強く依存する。

主な入力設計
- 組成ベクトル：元素比、濃度、ドープ量
- 記述子（descriptor）：原子半径、電気陰性度、価電子数、平均/分散など
- 構造特徴：結晶構造、局所配位、ボロノイ特徴、RDF要約、グラフ表現
- プロセス条件：温度、時間、雰囲気、電圧、スパッタ条件など
- 画像/スペクトル：XRD/XAFS/顕微鏡画像を低次元へ圧縮した表現（PCA、AEなど）

注意
- 次元が高いほど、必要サンプル数が増える（次元の呪い）
- 物理的に不変な量（対称性・単位系）を守る表現が重要である


## 4. 代表的なサロゲート手法
### 4.1 応答曲面（RSM: Response Surface Method）
多項式回帰などの単純近似であり、低次元・滑らかな応答に強い。
$$
\hat{f}(x)=a_0+\sum_i a_i x_i + \sum_{i\le j} a_{ij} x_i x_j + \cdots
$$
利点：実装が容易、解釈しやすい  
弱点：強い非線形・局所構造に弱い

### 4.2 Kriging / ガウス過程回帰（GPR）
確率過程として関数をモデル化し、平均（予測）と分散（不確かさ）を同時に出す。
予測分布（概念）
$$
\hat{y}(x) \sim \mathcal{N}(\mu(x),\sigma^2(x))
$$
利点：小サンプルで強い、探索の指針（不確かさ）が得られる  
弱点：データ数が増えると計算が重くなりやすい（工夫が必要）

### 4.3 RBF（Radial Basis Function）補間
$$
\hat{f}(x)=\sum_{i=1}^{n} w_i \,\phi(\|x-x_i\|)
$$
利点：補間として強い、実装が簡単  
弱点：ハイパーパラメータと外挿に注意が必要

### 4.4 決定木系（RF / GBDT）
利点：頑健、前処理が軽い、解釈（特徴重要度）が比較的容易  
弱点：滑らかな外挿が苦手な場合がある

### 4.5 ニューラルネット（MLP/CNN/GNN）
利点：高次元入力（画像・グラフ・構造）に強い  
弱点：データ量・正則化・リーク対策が重要、UQが別途必要なことが多い

### 4.6 低次元化＋サロゲート（ROM）
高次元出力（場、画像、組織）を潜在空間に落としてから近似する。
例：POD/PCAやオートエンコーダで $z$ に圧縮し、$x\to z$ を学習して復元する。

### 4.7 ニューラルオペレータ（Neural Operator）
PDE/場の入出力を「演算子」として学習し、シミュレーションの代理として使う枠組みである。
利点：場の予測の高速化に強い  
弱点：学習コスト、データ整備、汎化の評価が難しい


## 5. 不確かさ（UQ）と“外挿”の扱い
材料探索では、未知領域へ踏み込むため、予測の信頼度が重要である。

### 5.1 予測区間の例
GPR等で $\mu(x),\sigma(x)$ が得られるなら
$$
y \in \left[\mu(x)-z_{\alpha}\sigma(x),\ \mu(x)+z_{\alpha}\sigma(x)\right]
$$
のように扱える（正規近似の例）。

### 5.2 外挿を前提にしない設計
- 訓練領域を明示する（組成範囲、温度範囲、相の範囲）
- 外挿が必要な場合は、アクティブラーニングでデータを取りに行く


## 6. ベイズ最適化（BO）との統合
サロゲート（特にGPR）で $\mu(x),\sigma(x)$ を得て、次に測るべき $x$ を獲得関数で決める。

代表例：期待改善量（EI）
$$
\mathrm{EI}(x)=\mathbb{E}\left[\max(0,\ f(x)-f_{\mathrm{best}})\right]
$$

材料科学での意味
- 実験回数やDFT計算回数が少ない状況で、探索効率を最大化できる
- 自律実験（ロボット＋AI）と相性が良い


## 7. マルチフィデリティ（多忠実度）サロゲート
同じターゲットでも“精度とコスト”が違う情報源を統合する考え方である。

例
- 低忠実度：粗い計算、経験式、簡易測定
- 高忠実度：高精度DFT、精密測定

狙い
- 高忠実度データを節約しつつ、全体の推定精度を上げることである


## 8. 材料分野の具体例
### 8.1 DFTサロゲート（物性予測・スクリーニング）
- 入力：組成・構造記述子
- 出力：形成エネルギー、磁気量、弾性、バンドギャップなど
- 運用：候補生成→サロゲートで粗選別→少数をDFT再評価→更新

### 8.2 機械学習ポテンシャル（MLIP）は“力場のサロゲート”
- 目的：DFTのエネルギー/力を近似し、MDや大規模緩和を高速化する
- 注意：学習領域外の構造（相変態や欠陥生成）で破綻しやすく、能動学習が重要である

### 8.3 プロセス・AM・組織予測のサロゲート
- 入力：加工条件
- 出力：組織特徴（低次元表現）や特性
- 物理モデル（熱＋相場）を直接回す代わりに、潜在空間上のサロゲートで高速推定する設計が有効である


## 9. 構築手順
1. 問題定義：$x$ と $y$、目的（予測・最適化・感度・UQ）を固定する  
2. 実験計画/サンプリング：初期点を分散良く取る（LHSなど）  
3. 前処理：単位系、正規化、外れ値、欠損、時系列リークを対策する  
4. 学習：候補モデルを複数用意し、同じ分割で比較する  
5. 評価：RMSE/MAEに加え、外挿耐性と不確かさの較正も確認する  
6. 反復：誤差の大きい領域へ追加サンプルを打つ（アクティブラーニング）  
7. 運用：モデル・データ・条件を記録し、再現可能にする

評価指標（例）
$$
\mathrm{MAE}=\frac{1}{n}\sum_{i=1}^{n}|y_i-\hat{y}_i|,\quad
\mathrm{RMSE}=\sqrt{\frac{1}{n}\sum_{i=1}^{n}(y_i-\hat{y}_i)^2}
$$


## 10. よくある落とし穴
- データリーク：同一試料・同一ロット・同一測定日の混入で過大評価になる
- 相の切替：相変態点で関数が不連続に見え、滑らかなモデルが破綻する
- ラベルノイズ：実験のばらつきが支配的で、過学習しやすい
- 外挿の誤用：訓練領域外の推定値だけを信じて意思決定してしまう


## まとめ
サロゲートモデルは、高価な計算・実験を少数回だけ行い、それ以外を近似で補うことで探索と解析を加速するための中核技術である。材料科学では、GPR/Krigingを中心に不確かさを伴う探索（ベイズ最適化、自律実験）へ接続する構成が実務上強く、さらにROMやニューラルオペレータにより高次元現象（組織・場）の代理化も進展している。
