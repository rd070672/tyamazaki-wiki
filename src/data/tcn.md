# 時間畳み込みネットワーク（TCN）

TCNは、因果畳み込み（causal convolution）と拡張畳み込み（dilated convolution）を核に、系列データの長距離依存を畳み込みで扱うためのニューラルネットワークである。材料科学では、各種の計測波形・プロセスログ・シミュレーション時系列を、物理量の時系列として統一的に表現学習する基盤として有効である。

## 参考ドキュメント
- Bai et al., An Empirical Evaluation of Generic Convolutional and Recurrent Networks for Sequence Modeling (arXiv, 2018)
  https://arxiv.org/abs/1803.01271
- locuslab/TCN（公式実装・ベンチマーク）
  https://github.com/locuslab/TCN
- Qiita：TCN (Temporal Convolutional Network) とは？（日本語）
  https://qiita.com/ooyamatakehisa/items/2a044b41c69f3c8802ef
  
## 1. 位置づけ（RNNとの関係）
系列モデリングの代表はRNN/LSTM/GRUであるが、TCNは「1次元畳み込みで系列を扱う」発想を徹底し、並列計算性と安定学習を重視した系列モデルである。

- RNN系：逐次更新により履歴を状態に畳み込む（時刻方向に本質的に逐次）
- TCN：受容野（receptive field）を広げて、過去の広い範囲を一度に参照する（時刻方向に並列）

材料データでは、例えば「磁気雑音波形」「温度履歴」「電圧・電流プロファイル」「結晶粒径分布の時間発展」などが、いずれもTCNの入力候補である。

## 2. TCNの最小要件（何がTCNをTCNにするか）
多くの文脈でTCNは、次の設計要件を満たす系列用CNNを指すことが多い。

1) 因果性（causality）
時刻tの出力が、未来（t+1以降）の入力に依存しない設計である。

2) 拡張（dilation）
畳み込みの間引き幅を増やし、パラメータ数を大きく増やさず受容野を指数的に拡大する設計である。

3) 残差接続（residual connection）
深いネットワークでも勾配が流れやすいように、残差ブロック（ResNet様式）を用いる設計である。

補足として、実装では「入力長と出力長が一致する（sequence-to-sequenceの長さ保持）」ようにパディングを設計することが多い。

## 3. 数式表現（因果・拡張1D畳み込み）
入力系列を $x_t$、カーネルサイズを $K$、拡張率を $d$ とすると、拡張因果畳み込みは概念的に次で表せる。

$$
y_t=\sum_{k=0}^{K-1} w_k \, x_{t-dk}
$$

ここで $x_{t-dk}$ は過去側のみを参照するため、因果性が満たされる。

### 3.1 受容野（receptive field）
層 $l$ の拡張率を $d_l$ とし、同一カーネルサイズ $K$ の層を $L$ 層積むと、受容野 $R$ は概算で

$$
R = 1 + \sum_{l=0}^{L-1} (K-1)d_l
$$

拡張率を指数的に $d_l=2^l$ とすれば、

$$
R = 1 + (K-1)(2^L-1)
$$

となり、層数に対して過去参照範囲を大きくできる。

### 3.2 計算量の直観
標準的なTCNは、各層が畳み込みであるためGPU並列に乗りやすい。一方で、長い系列では活性のメモリ使用量が増えるため、系列長 $T$ と層数の設計が実用上のボトルネックになり得る。

## 4. ブロック構成
TCNは「拡張因果Conv → 正規化 → 活性化 → Dropout」を2回程度繰り返し、入力をスキップして足し合わせる残差ブロックとして構成されることが多い。

設計パラメータの材料データ的な意味づけは次の通りである。

- カーネルサイズ $K$：局所的な相関幅（例：スペクトル窓幅、波形の特徴時間）
- 拡張率系列 $\{d_l\}$：多重時間スケール（例：磁壁運動と渦電流緩和、急冷と拡散、加熱と累積熱）
- チャネル数：同時観測の多変量性（例：磁場・電流・温度・ひずみ、複数センサ）

## 5. 入力設計（何を時系列として与えるか）
TCN適用の成否は「何を時間軸上のチャネルとして定義するか」で決まる。

### 5.1 計測由来（実験）
- 磁気：B-H波形、MBN波形、透磁率の周波数掃引、ホール信号の時系列
- 構造・プロセス：熱履歴（熱電対）、レーザ入熱プロファイル、成膜中ログ、圧延・加工の荷重履歴
- 電気化学：充放電カーブ（V,I,T）、EISの系列化（条件付けの工夫が必要）

### 5.2 シミュレーション由来（計算）
- MD：エネルギー、温度、RDF特徴量、配位数などの時間発展
- フェーズフィールド：相分率、特徴長、粒径分布の要約統計の時間発展
- マイクロ磁気：平均磁化、損失、スペクトル量の時間発展（波形入力にもできる）

## 6. 典型タスクと出力形式（材料に落とす）
- 回帰：物性値、劣化指標、残寿命、粒径分布パラメータなど
- 分類：相分類、異常検知（プロセス異常、欠陥兆候）、状態分類（熱処理状態など）
- 予測（forecasting）：将来の温度・形状・分布・信号波形を多ステップで予測する

多ステップ予測では、(i) 1ステップ予測を繰り返す再帰型、(ii) 未来区間を一括で出す直接型、(iii) 両者の折衷、を用途に応じて選ぶのが通例である。

## 7. 物理制約・実験条件をどう扱うか
TCN自体は物理制約を自動では満たさないため、材料分野では次のいずれか（または併用）が必要である。

- 前処理での整合化：単位、サンプリング周期、ゼロ点、温度・磁場条件の正規化
- 条件の明示入力：温度、組成、熱処理条件、応力などを追加チャネルとして与える
- 制約付き学習：非負性、単調性、保存則、境界条件などを損失関数や出力変換で課す
- 外挿耐性の設計：未知組成域や未知プロセス条件を評価セットとして固定する

## 8. 注意点
- データリーク：同一材料ロット、近縁組成、同一試料の条件違いが学習と評価に跨る問題である
- 時間分割の誤り：未来データに依存する特徴量（例：全区間平均との差分）を混入させる問題である
- 外挿評価不足：未知元素系・未知組成域・未知プロセス域での性能が本質である
- ノイズとドリフト：装置ドリフトや環境変動を「物性変化」と誤学習し得る

## 9. 応用例（論文例）
- 多結晶材料の粒成長（grain growth）時系列に対し、LSTM/TCN/Transformerなどを比較した例
  https://arxiv.org/abs/2511.11630
- Liイオン電池の状態推定（SOH）にTCNを用い、部分的な負荷プロファイルから推定する例
  https://www.sciencedirect.com/science/article/pii/S0306261922015641
- 金属積層造形（DED）で、物理駆動のTCNにより溶融池幅や層高を予測した先行研究が整理されている例（レビュー内言及を含む）
  https://link.springer.com/article/10.1007/s10845-025-02714-1

## まとめ
- TCNは、因果性と拡張畳み込みにより長距離依存を扱う系列用CNNであり、RNNより並列計算性に優れやすい枠組みである。
- 材料科学では、計測波形・プロセスログ・シミュレーション時系列を、時間スケール混在の多変量系列として扱う際に特に有効である。
- 実用上は、モデル選択以上に、入力設計（チャネル定義）、条件の明示、データ分割（リーク対策）、外挿評価設計が支配的である。

